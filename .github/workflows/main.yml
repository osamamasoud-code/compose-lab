name: Deploy to Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare SSH key
        env:
          SSH_KEY_B64: ${{ secrets.SSH_KEY_B64 }}
        run: |
          set -e
          echo "$SSH_KEY_B64" | tr -d '\n\r ' | base64 -d > /tmp/key
          chmod 600 /tmp/key
          ssh-keygen -lf /tmp/key

      - name: Debug host value
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          set -e
          echo "SSH_HOST='$SSH_HOST'"
          getent hosts "$SSH_HOST" || true

      - name: Deploy via SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          set -e
          ssh -o StrictHostKeyChecking=no -i /tmp/key ${SSH_USER}@${SSH_HOST} '
            set -e
            cd ~/compose-lab
            git fetch origin
            git reset --hard origin/main
            docker compose pull
            docker compose up -d --force-recreate
            docker compose ps
          '
