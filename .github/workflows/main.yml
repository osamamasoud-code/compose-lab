name: Deploy to Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare SSH key
        env:
          SSH_KEY_B64: ${{ secrets.SSH_KEY_B64 }}
        run: |
          set -e
          echo "$SSH_KEY_B64" | tr -d '\n\r ' | base64 -d > /tmp/key
          chmod 600 /tmp/key
          ssh-keygen -lf /tmp/key

      - name: Normalize host/user and debug
        env:
          SSH_HOST_RAW: ${{ secrets.SSH_HOST }}
          SSH_USER_RAW: ${{ secrets.SSH_USER }}
        run: |
          set -e
          SSH_HOST="$(printf '%s' "$SSH_HOST_RAW" | tr -d '\r\n ' )"
          SSH_USER="$(printf '%s' "$SSH_USER_RAW" | tr -d '\r\n ' )"
          echo "SSH_HOST='$SSH_HOST'"
          echo "SSH_USER='$SSH_USER'"
          getent hosts "$SSH_HOST" || true

      - name: Deploy via SSH
        env:
          SSH_HOST_RAW: ${{ secrets.SSH_HOST }}
          SSH_USER_RAW: ${{ secrets.SSH_USER }}
        run: |
          set -e
          SSH_HOST="$(printf '%s' "$SSH_HOST_RAW" | tr -d '\r\n ' )"
          SSH_USER="$(printf '%s' "$SSH_USER_RAW" | tr -d '\r\n ' )"
          ssh -o StrictHostKeyChecking=no -i /tmp/key ${SSH_USER}@${SSH_HOST} '
            set -e
            cd ~/compose-lab
            git fetch origin
            git reset --hard origin/main
            docker compose pull
            docker compose up -d --force-recreate
            docker compose ps
          '
