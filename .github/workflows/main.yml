name: Deploy to Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare SSH key
        env:
          SSH_KEY_B64: ${{ secrets.SSH_KEY_B64 }}
        run: |
          set -e
          KEY_PATH="$GITHUB_WORKSPACE/key"
          echo "$SSH_KEY_B64" | tr -d '\n\r ' | base64 -d > "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          ssh-keygen -lf "$KEY_PATH"

      - name: Deploy via SSH
        env:
          SSH_HOST_RAW: ${{ secrets.SSH_HOST }}
          SSH_USER_RAW: ${{ secrets.SSH_USER }}
        run: |
          set -e
          KEY_PATH="$GITHUB_WORKSPACE/key"
          SSH_HOST="$(printf '%s' "$SSH_HOST_RAW" | tr -d '\r\n ' )"
          SSH_USER="$(printf '%s' "$SSH_USER_RAW" | tr -d '\r\n ' )"

          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=20 -i "$KEY_PATH" "${SSH_USER}@${SSH_HOST}" bash -s <<'EOF'
          set -e
          cd ~/compose-lab

          git fetch origin
          git pull --rebase origin main

          docker compose pull
          docker compose up -d --force-recreate

          echo "== compose ps =="
          docker compose ps

          echo "== last 30 lines of web logs =="
          docker compose logs --tail=30 web
          EOF
